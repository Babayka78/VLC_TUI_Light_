# Исправление проблемы с CEC

**Дата:** 28.11.2025, 17:05  
**Статус:** ИСПРАВЛЕНО

---

## Найденная проблема

**Симптомы:**
- Видео запускалось
- Сообщение "Мониторинг пульта..." появлялось
- НО цикл обработки CEC команд не запускался (пульт не работал)

**Причина:**
В первой версии мы добавили запуск мониторинга ДО запуска cec-client:
```bash
# НЕПРАВИЛЬНО:
MONITOR_PID=$(monitor_vlc_playback "$VIDEO_FILE" $VLC_PID)  # ← Это блокировало!
```
cec-client -d 8 -t r "$CEC_DEVICE" 2>&1 | while...
```

Функция `monitor_vlc_playback()` возвращает PID через `echo $!`, НО если вызов через `$(...)` - это может заблокировать поток или перенаправить output.

---

## Решение

**Изменение:** Переместили запуск мониторинга ПОСЛЕ начала CEC цикла:

```bash
# Мониторим CEC
cec-client -d 8 -t r "$CEC_DEVICE" 2>&1 | while IFS= read -r line; do
    # ... обработка кнопок ...
done &

CEC_PID=$!

# ПРАВИЛЬНО: Запуск мониторинга ПОСЛЕ (&исправлено)
monitor_vlc_playback "$VIDEO_FILE" $VLC_PID &
MONITOR_PID=$!
```

**Ключевые изменения:**
1. ✅ Мониторинг запускается ПОСЛЕ `CEC_PID=$!` 
2. ✅ Используем `&` напрямую вместо `$(...)`
3. ✅ Сохраняем PID через `$!` отдельно

---

## Применённые изменения (версия V4)

### 1. Подключение библиотеки (после строки 18)
Без изменений - работает корректно

### 2. Запуск мониторинга
**БЫЛО (неправильно):** После строки 69, ДО cec-client  
**СТАЛО (правильно):** После строки 331, ПОСЛЕ CEC_PID=$!

```bash
done &

CEC_PID=$!

# Запускаем мониторинг прогресса в фоне (ПОСЛЕ CEC)
monitor_vlc_playback "$VIDEO_FILE" $VLC_PID &
MONITOR_PID=$!
```

### 3. Cleanup
Без изменений - работает правильно  

---

## Тестирование

**Требуется проверка:**
```bash
./vlc-cec.sh /path/to/video.avi
```

**Ожидается:**
- ✅ VLC запускается
- ✅ CEC мониторинг работает (пульт отвечает)
- ✅ Автосохранение работает (каждые 60 сек)
- ✅ Ctrl-C вызывает cleanup корректно
- ✅ Финальное сохранение при выходе

---

**Бэкапы:**
- Рабочая версия: `vlc-cec_V3_251128_1649.bak`
- Версия перед исправлением: `vlc-cec_V4_251128_1705.bak`
