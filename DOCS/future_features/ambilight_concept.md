# Технический анализ: Ambilight для текущей конфигурации

**Дата:** 27.11.2025  
**Контекст:** RPi4 + Arduino UNO/ESP32-CAM/SP108E + видео через sshfs WiFi

---

## 🎯 О названии проекта

### Да, можно переименовать на GitHub!

**Способ 1: Переименовать репозиторий**
```
Settings → Repository name → Rename
```
- ✅ Простой переименование
- ⚠️ Все ссылки изменятся
- ✅ GitHub делает автоматический redirect

**Способ 2: Только в readme**
- Можно сначала использовать временное название
- Потом обновить README.md и документацию

**Рекомендация:** Используйте временное `vlc-ambilight-pi` сейчас, потом переименуем.

---

## 🔌 Анализ доступного оборудования

### Что у вас есть:

```
┌─────────────────┬──────────────┬───────────────────────────┐
│ Устройство      │ Статус       │ Возможности для проекта   │
├─────────────────┼──────────────┼───────────────────────────┤
│ Arduino UNO     │ ✅ Работает  │ Управление LED (МАКС 1-2  │
│                 │              │ ленты из-за памяти)       │
├─────────────────┼──────────────┼───────────────────────────┤
│ ESP32-CAM       │ ✅ Работает  │ - WiFi, камера            │
│                 │              │ - Может быть LED контроллер│
│                 │              │ + capture через камеру?   │
├─────────────────┼──────────────┼───────────────────────────┤
│ ESP32           │ ⚠️ Проблемы  │ Если починить - отличный  │
│                 │ с загрузкой  │ вариант (WiFi + мощность) │
├─────────────────┼──────────────┼───────────────────────────┤
│ SP108E          │ ❓ Не тестил │ LED контроллер с видео    │
│                 │              │ функцией (?)              │
└─────────────────┴──────────────┴───────────────────────────┘
```

### ⭐ SP108E - потенциально лучшее решение!

**Что такое SP108E:**
- LED контроллер для WS2812B лент
- Управление через WiFi (приложение)
- Поддержка музыкальных эффектов
- **ВАЖНО:** Проверить функцию "video mode"

**Если SP108E поддерживает video capture:**
- ✅ Не нужен Arduino
- ✅ Меньше нагрузка на RPi
- ✅ Готовое решение

**Задача:** Протестировать SP108E и его возможности!

---

## 📊 Нагрузка на Raspberry Pi 4

### Текущая конфигурация:

```
┌─────────────────────────────────────────────────────────┐
│                    Ваша система                          │
│                                                          │
│  Mac (видео файлы)                                       │
│       │                                                  │
│       │ WiFi + sshfs                                     │
│       ▼                                                  │
│  Raspberry Pi 4                                          │
│  ┌──────────────────────┐                                │
│  │ VLC Player           │◄── ЭТО УЖЕ НАГРУЖАЕТ WiFi!    │
│  │ (читает через sshfs) │                                │
│  └──────────────────────┘                                │
└─────────────────────────────────────────────────────────┘
```

### Критическая проблема: Двойная нагрузка на WiFi

**Если использовать VLC + FFmpeg одновременно:**

```
Mac ──WiFi──► RPi4
              ├─► VLC читает видео (стрим 1)
              └─► FFmpeg читает то же видео? (стрим 2)
                  
Проблема: WiFi перегрузится!
```

**Пропускная способность:**
- Видео 1080p: ~10-20 Mbps
- WiFi x2: ~20-40 Mbps
- WiFi может не справиться!

---

## 🚀 Рекомендуемое решение для вашей конфигурации

### Вариант A: VLC Framebuffer Capture (ЛУЧШИЙ!)

**Идея:** VLC выводит на framebuffer, захватываем оттуда

```
Mac ──WiFi──► RPi4: VLC ──► /dev/fb0 (framebuffer)
                             │
                             └──► Python скрипт
                                  ├─ Читает /dev/fb0
                                  ├─ Анализирует цвета
                                  └─ Отправляет в Arduino/ESP32
```

**Преимущества:**
- ✅ Только ОДИН видеопоток по WiFi
- ✅ Низкая дополнительная нагрузка
- ✅ Реальное изображение с экрана
- ✅ Синхронизация автоматическая

**Реализация:**

```python
#!/usr/bin/env python3
# ambi-framebuffer.py

import mmap
import struct
from PIL import Image

class FramebufferCapture:
    def __init__(self, device='/dev/fb0'):
        # Получить параметры framebuffer
        with open('/sys/class/graphics/fb0/virtual_size', 'r') as f:
            width, height = map(int, f.read().strip().split(','))
        
        self.width = width
        self.height = height
        self.fb_size = width * height * 4  # 32-bit RGBA
        
        # Открыть framebuffer
        self.fb = open(device, 'rb')
        self.mem = mmap.mmap(self.fb.fileno(), self.fb_size, 
                            mmap.MAP_SHARED, mmap.PROT_READ)
    
    def capture(self):
        """Захватить текущий кадр"""
        self.mem.seek(0)
        data = self.mem.read(self.fb_size)
        
        # Конвертировать в PIL Image
        img = Image.frombytes('RGBA', (self.width, self.height), data)
        return img.convert('RGB')
    
    def close(self):
        self.mem.close()
        self.fb.close()
```

**Нагрузка на RPi4:**
- CPU: ~5-10% (чтение framebuffer очень легкое!)
- RAM: ~50MB
- WiFi: БЕЗ изменений (тот же поток как сейчас)

---

### Вариант B: VLC Snapshot через HTTP (ЗАПАСНОЙ)

**Если framebuffer не работает:**

```bash
# Запуск VLC с HTTP интерфейсом
cvlc --extraintf http --http-host 0.0.0.0 --http-port 8080 video.mp4

# Python захват snapshot
import requests
response = requests.get('http://localhost:8080/?command=snapshot')
```

**Проблемы:**
- ⚠️ Snapshot может быть медленным
- ⚠️ Не реал-тайм (задержка 1-2 сек)

---

### Вариант C: ESP32-CAM как capture device (КРЕАТИВНЫЙ!)

**Безумная идея:** Направить ESP32-CAM на телевизор

```
TV Screen ◄──HDMI──► [VLC output]
    │
    │ ESP32-CAM снимает экран физически!
    ▼
ESP32-CAM ──WiFi──► Python анализ ──► Arduino
```

**Pros:**
- ✅ Независимо от VLC
- ✅ Работает с любым источником
- ✅ Низкая нагрузка на RPi

**Cons:**
- ❌ Качество зависит от позиционирования
- ❌ Нужна правильная установка камеры
- ❌ Освещение может мешать

**Оценка:** Интересно, но сложнореализуемо.

---

## 🎯 Итоговая рекомендация

### Фаза 1: Тестирование SP108E

**Приоритет #1:** Проверить SP108E

```bash
# Задачи:
1. Подключить SP108E к сети
2. Установить родное приложение
3. Проверить функцию "video mode" / "screen mirroring"
4. Если работает - использовать это!
```

**Если SP108E имеет screen capture:**
- ✅ ГОТОВОЕ РЕШЕНИЕ
- ✅ Минимум доработок
- ✅ Не нужен Python анализ

---

### Фаза 2: Framebuffer + Arduino UNO (если SP108E не подходит)

**План:**

```
1. Python скрипт:
   - Читает /dev/fb0 (5-10 FPS)
   - Анализирует 5 зон
   - Упрощенный алгоритм (быстро!)

2. Arduino UNO:
   - Управляет 1-2 LED лентами максимум
   - Может Top + Bottom зоны
   - Или Left + Right зоны

3. Оптимизация:
   - Снизить разрешение анализа (320x180 вместо 1920x1080)
   - Анализировать каждый N-й кадр
   - Сглаживание переходов
```

**Ограничения Arduino UNO:**
- RAM: 2KB (очень мало!)
- Рекомендация: МАКСИМУМ 2 ленты по 30-60 LED

---

### Фаза 3: ESP32-CAM как LED контроллер (перспектива)

**Если почините ESP32:**
- Использовать как мощный LED контроллер
- Получать данные по WiFi
- Управлять всеми 5 лентами

**Arduino UNO vs ESP32:**

```
┌────────────────┬────────────┬─────────────┐
│ Параметр       │ Arduino UNO│ ESP32       │
├────────────────┼────────────┼─────────────┤
│ RAM            │ 2 KB       │ 520 KB      │
│ Лент (макс)    │ 1-2        │ 5+          │
│ Связь          │ Serial USB │ WiFi/Serial │
│ Скорость       │ 16 MHz     │ 240 MHz     │
└────────────────┴────────────┴─────────────┘
```

---

## 📈 Оценка нагрузки на RPi4

### Тест конфигурация:

```
VLC playback:           20-30% CPU
Framebuffer capture:    5-10% CPU
Color analysis:         5-10% CPU
Serial/WiFi send:       1-2% CPU
─────────────────────────────────
ИТОГО:                  ~31-52% CPU

RAM: ~200-300MB (из 4GB доступных)
WiFi: БЕЗ ИЗМЕНЕНИЙ (тот же поток)
```

**Вывод:** RPi4 справится! ✅

---

## ⚡ Оптимизация производительности

### 1. Снижение разрешения анализа

```python
def capture_and_downsample(self):
    img = self.capture()  # 1920x1080
    # Уменьшить до 320x180 для анализа
    img_small = img.resize((320, 180), Image.BILINEAR)
    return img_small

# Скорость анализа: ↑×10-20!
```

### 2. Пропуск кадров

```python
# Анализировать только каждый 3-й кадр
frame_counter = 0
if frame_counter % 3 == 0:
    analyze_colors()
frame_counter += 1
```

### 3. Многопоточность

```python
import threading

# Поток 1: Захват кадров
# Поток 2: Анализ цветов
# Поток 3: Отправка в Arduino
```

---

## 🛠️ Минимальный рабочий прототип

### Что нужно для старта:

**Software (RPi):**
```bash
# 1. Python библиотеки
pip3 install pillow pyserial

# 2. Доступ к framebuffer
sudo chmod a+r /dev/fb0
```

**Hardware:**
```
1. Arduino UNO
2. 1-2 LED ленты WS2812B (30-60 LED)
3. Блок питания 5V/2-3A
4. Резистор 470Ω для data линии
```

**Code:**
```
ambi-simple.py   - 150 строк Python
arduino_simple.ino - 50 строк Arduino
```

**Время реализации:** 2-3 часа для прототипа!

---

## 📝 План действий

### Сегодня/Завтра:

1. **✅ Создать GitHub репозиторий**
   - Временное название: `vlc-ambilight-pi`
   - Залить текущий VLC код

2. **🔍 Протестировать SP108E**
   - Подключить
   - Проверить video mode
   - Если работает → сэкономите кучу времени!

3. **🧪 Тест framebuffer capture**
   - Простой Python скрипт
   - Захват одного кадра
   - Проверка производительности

### Через 2-3 дня:

4. **🚀 Прототип с Arduino UNO**
   - 1 LED лента
   - 1 зона (например, Top)
   - Базовый proof of concept

5. **📊 Оптимизация**
   - Подбор FPS
   - Сглаживание
   - Добавление зон

---

## ❓ Ответы на ваши вопросы

### Q: Нагрузка на RPi4 при framebuffer capture?
**A:** ~5-10% CPU, очень легко! ✅

### Q: Синхронизация VLC + FFmpeg?
**A:** НЕ НУЖНА! Framebuffer capture = автосинхронизация ✅

### Q: Нагрузка на WiFi?
**A:** БЕЗ ИЗМЕНЕНИЙ (тот же видеопоток как сейчас) ✅

### Q: Arduino UNO хватит?
**A:** Для 1-2 лент - да, для 5 - нужен ESP32 ⚠️

---

## 🎯 Главная рекомендация

**Начните с SP108E тестирования!**

Если SP108E поддерживает screen mirroring:
- Готовое решение за ~1 час настройки
- Минимум кода
- Все 5 лент работают

Если SP108E не подходит:
- Framebuffer capture + Arduino UNO
- Начать с 1-2 лент
- Потом расширить до ESP32

---

**Следующий шаг:** Проверьте SP108E! 🔍
